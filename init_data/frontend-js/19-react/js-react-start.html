<h1>ReactJs начало. Рабочее окружение.</h1>

<h2>Быстрый старт проекта (скафолдинг).</h2>

<pre><code>npx create-react-app my-app --template typescript
</code></pre>

<p>Запуск сервера</p>

<pre><code>npm run start
</code></pre>

<p>Сборка.</p>

<pre><code>npm run build
</code></pre>

<p>Сборка с отслеживанием изменений.</p>

<pre><code>npm install npm-watch --save
</code></pre>

<p>Добавляем в package.json</p>

<pre><code>...
"watch": {
    "build": {
      "patterns": [
        "src"
      ],
      "extensions": "js,jsx"
    }
  },
  "scripts": {
    "watch": "npm-watch",

  ....
</code></pre>

<p>Запуск.</p>

<pre><code>npm run watch
</code></pre>

<h2>Ставим реакт в ручную.</h2>

<pre><code>npm install react react-dom --save
npm install @types/react --save
</code></pre>

<p>Переименуем index.ts в index.tsx</p>

<p>Добавим опцию jsx в tsconfig.json</p>

<pre><code>{
    "compilerOptions": {
        "module": "commonjs",
        "target": "ES5",
        "outDir": "dist",
        "rootDir": "src",
        "esModuleInterop": true,
        "jsx": "react"
    },
    "exclude": [
        "node_modules"
    ]
}
</code></pre>

<p>Создадим простейший компонент src/client/index.tsx.</p>

<pre><code>import * as React from "react";
import * as ReactDOM from 'react-dom';

function App() {
    return (
      &lt;h1&gt;Hello from react!&lt;/h1&gt;
    );
}

ReactDOM.render(
    &lt;App /&gt;,
    document.getElementById('react-app')
  );
</code></pre>

<p>Установка SystemJs</p>

<pre><code>npm install systemjs@0.19.22 --save
</code></pre>

<p>Подключаем в загрузчике.</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;&lt;title&gt;TypeScript Greeter&lt;/title&gt;
        &lt;script src="node_modules/systemjs/dist/system.js"&gt;&lt;/script&gt;

    &lt;/head&gt;
    &lt;body&gt;
       &lt;div id="react-app"&gt;&lt;/div&gt;
      &lt;script&gt;
            SystemJS.config({
                defaultJSExtensions: true,
                map: {
                    'react': 'node_modules/react/umd',
                    'react-dom': 'node_modules/react-dom/umd'
                },
                packages: {
                    'react': {
                        main: './react.development.js'
                    },
                    'react-dom': {
                        main: './react-dom.development.js'
                    }
                }
            });
            SystemJS.import('dist/client/index.js');           
      &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Использование сборщика вместо SystemJs.</p>

<p>Устанавливаем gulp.</p>

<pre><code>npm install --save gulp
</code></pre>

<p>Делаем простую задачу в файле gulp.js.</p>

<pre><code>var gulp = require('gulp');
gulp.task('default', () =&gt; {
    console.log('Gulp task!!');
})
</code></pre>

<p>Запуск.</p>

<pre><code>node node_modules/gulp/bin/gulp.js
</code></pre>

<p>Так как процесс асинхронный мы должны вернуть событие завершения.</p>

<pre><code>var gulp = require('gulp');
gulp.task('default', (done) =&gt; {
    console.log('Gulp task!!');
    done();
})
</code></pre>

<p>Установим компилятор gulp-typescript</p>

<pre><code> npm install --save gulp-typescript
 npm install --save browserify
</code></pre>

<p>Откомпилируем в папку dist/prod</p>

<pre><code>var gulp = require('gulp');
var browserify = require('browserify');
var ts = require("gulp-typescript");
var tsProject = ts.createProject("tsconfig.json");
gulp.task('default', (done) =&gt; {
    return tsProject.src()
        .pipe(tsProject())
        .js.pipe(gulp.dest("dist/prod"));

})
</code></pre>

<p>Теперь нам необходимо собрать все модули в один файл.</p>

<p>Сначала установим browserify, tsify, и vinyl-source-stream. tsify это плагин для Browserify, который, подобно gulp-typescript, предоставляет доступ к компилятору TypeScript. vinyl-source-stream позволяет согласовать файловый вывод Browserify и формат под названием vinyl, который понимает gulp.</p>

<pre><code>npm install --save-dev browserify tsify vinyl-source-stream
</code></pre>

<p>Скрипт сборки.</p>

<pre><code>var gulp = require('gulp');
var browserify = require('browserify');
var source = require('vinyl-source-stream');
var tsify = require("tsify");

gulp.task('default', (done) =&gt; {
    return browserify({
        basedir: './src/client',
        debug: true,
        entries: ['index.tsx']
    })
    .plugin(tsify)
    .bundle()
    .pipe(source('bundle.js'))
    .pipe(gulp.dest("dist/prod"));

})
</code></pre>

<p>Теперь можно включить наш бандл в страницу одним файлом и убрать SystemJs.</p>

<pre><code>&lt;script src="dist/prod/bundle.js"&gt;&lt;/script&gt;
</code></pre>

<p>bundle получился около 4.1 мб.</p>

<p>Попробуем аглифицировать (обфуркация).</p>

<p>Устоановка</p>

<pre><code>npm install gulp-uglify --save
npm install vinyl-buffer --save
</code></pre>

<p>Применение.
    ...
    var uglify = require('gulp-uglify');
    var buffer = require('vinyl-buffer');</p>

<pre><code>gulp.task('default', (done) =&gt; {
    return browserify({
        basedir: './src/client',
        debug: true,
        entries: ['index.tsx']
    })
    .plugin(tsify)
    .bundle()
    .pipe(source('bundle.js'))
    .pipe(buffer())
    .pipe(uglify())
    .pipe(gulp.dest("dist/prod"));

})
</code></pre>

<p>Получаем ошибку.</p>

<p><img src="https://webmonstr.com/media/course/frontend-js/19-react/images/4.png" alt="start page" /></p>

<p>Оказывается uglify не поддерживает es6.</p>

<p>Ставим тот что поддерживает.</p>

<pre><code>npm i gulp-uglify-es --save
</code></pre>

<p>Меняем скрипт.</p>

<pre><code>var uglify = require('gulp-uglify-es').default;
</code></pre>

<p><img src="https://webmonstr.com/media/course/frontend-js/19-react/images/5.png" alt="start page" /></p>

<p>Теперь  bundle.js уменьшился до 1.4 мб</p>

<p>Обработка css требует еще одной библиотеки.</p>

<pre><code>npm install --save css-modulesify
</code></pre>

<p>Приминение.</p>

<pre><code>var cssModulesify = require('css-modulesify');
....
gulp.task('default', (done) =&gt; {
    return browserify(...)
    .plugin(cssModulesify, {
        rootDir: __dirname,
        output: './dist/main.css',
        generateScopedName: cssModulesify.generateShortName
      })
    ...
</code></pre>

<p>Отслеживание изменений при помощи nodemon.    </p>

<pre><code>sudo npm install -g nodemon
</code></pre>

<p>Команда для запуска.</p>

<pre><code>nodemon node_modules/gulp/bin/gulp.js -e tsx
</code></pre>

<p>Удаление билда перед пересозданием.</p>

<p>Устанавливаем библиотеку.</p>

<pre><code>npm install --save-dev del
</code></pre>

<p>Использование.</p>

<pre><code>var del = require('del');

gulp.task('default', (done) =&gt; {
    del(['../app/static/js/app/**'],{force: true});
</code></pre>

<p>Попробуем еще уменьшить компрессором gzip</p>

<pre><code>npm i compression --save
</code></pre>

<p>Вставляем в код сервера.</p>

<pre><code>const compression = require('compression');
app.use(compression())
</code></pre>

<p>По итогу получили.</p>

<p><img src="https://webmonstr.com/media/course/frontend-js/19-react/images/6.png" alt="start page" /></p>

<p>340 кб - неплохо, учитывая что это все вместе с библиотекой React.</p>

<p>Теперь разберемся как копировать index.html в сборку.</p>

<p>Создадим html для продакшина, который использует бандл src/server/tpl/index_prod.html.</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;Production&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
       &lt;div id="react-app"&gt;&lt;/div&gt;
      &lt;script src="dist/prod/bundle.js"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Т.к. мы будем копировать с другим именем установим библиотеку для этого.</p>

<pre><code>npm i gulp-rename --save
</code></pre>

<p>Скопируем index_prod.html как index.html при сборке в каталог dist.</p>

<p>Сделаем это в отдельной задаче</p>

<pre><code>rename = require('gulp-rename'),
gulp.task("copy-html", function () {
    return gulp.src('./src/server/tpl/index_prod.html')
        .pipe(rename('index.html'))
        .pipe(gulp.dest("dist/prod"));
});
</code></pre>

<p>Запускаем</p>

<p><img src="https://webmonstr.com/media/course/frontend-js/19-react/images/7.png" alt="start page" /></p>

<p>Теперь включим эту задачу в основную сборку.</p>

<h3>Комбинирование задач.</h3>

<pre><code>gulp.task("copy-html", function () {
   ...
});


gulp.task('build-app', (done) =&gt; {
    ...
})

gulp.task('default', gulp.series('copy-html', 'build-app'));
</code></pre>
